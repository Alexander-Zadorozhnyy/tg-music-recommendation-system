# Модуль получения текстов песен

## Назначение

Этот модуль предназначен для получения текстов песен по запросам из очереди RabbitMQ. Он:

- проверяет, есть ли песня в локальной базе (CSV);
- при отсутствии — запрашивает текст через API Genius;
- извлекает ключевые слова из текста с помощью KeyBERT;
- возвращает ответ с текстами и ключевыми словами в выходную очередь.

---

## Структура проекта

```md
lyrics_service/
├── src/
│   ├── main.py               # Запуск воркера, потребление сообщений из RabbitMQ
│   ├── request_processor.py  # Основная логика обработки сообщений
│   ├── text_compressor.py    # Извлечение ключевых слов из текста (KeyBERT)
│   ├── repo_csv.py           # Получение текста песни из CSV (локальная "БД")
│   └── models.py             # Типизация структуры сообщений
├── data/
│   └── songs.csv             # CSV-файл с песнями (аналог БД)
├── Dockerfile                # Образ контейнера
└── requirements.txt          # Зависимости
```

---

## Описание основных компонентов

### `main.py`

Инициализирует подключение к RabbitMQ, подписывается на входящую очередь `fetch_lyrics` и обрабатывает каждое сообщение с помощью `process_message`.

### `processor.py`

Основная логика:

- проверка наличия текста в CSV;
- запрос к Genius API при необходимости;
- извлечение ключевых слов;
- формирование ответа.

### `repo_csv.py`

Работает с файлом `songs.csv`:

- ищет песню по артисту и названию;
- возвращает текст песни, если он есть.

### `text_compressor.py`

Использует KeyBERT для извлечения топ-5 ключевых слов из текста.

### `models.py`

Содержит описание входного и выходного сообщений (TypedDict):

- `IncomingMessage`
- `OutgoingMessage`

---

## Формат сообщений

### Входящее сообщение (`fetch_lyrics`)

```json
{
  "id": "req1",
  "user_id": "user42",
  "song_credits": [
    {"artist": "Radiohead", "song": "Creep"},
    {"artist": "Adele", "song": "Hello"}
  ],
  "query": "что-то грустное"
}
```

### Выходящее сообщение (`lyrics_ready`)

```json
{
  "id": "req1",
  "user_id": "user42",
  "query": "что-то грустное",
  "songs_texts": [
    {
      "artist": "Radiohead",
      "song": "Creep",
      "lyrics": "...",
      "keywords": ["sadness", "alone", ...]
    },
    ...
  ]
}
```

---

## Как протестировать

1. Используйте `send_test_message.py`:

```bash
python send_test_message.py
```

2. Проверьте очередь `lyrics` — там появится результат.

---

## Примечания

- Если песни нет в `songs.csv`, модуль попытается получить текст через Genius.
- Парсинг текста осуществляется с помощью BeautifulSoup.
- Извлечённые тексты и ключевые слова можно использовать в downstream модулях (например, RAG или фильтрация по темам).
- `songs.csv` — временное решение. В будущем можно заменить на PostgreSQL + OpenSearch.

---

## Возможные улучшения

- Кэшировать тексты песен, полученные с Genius.
- Добавить логирование.
- Вынести обработку ошибок в отдельный модуль.
- Перейти от парсинга HTML к официальной обёртке `lyricsgenius`.
