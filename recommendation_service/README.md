# Модуль получения текстов песен

## Назначение

Этот модуль предназначен для преобразования текстов песен в конечные рекомендации, используя OpenSearch сервис. Он:

- получает данные по текстам песен и query для поиска в БД;
- формирует при помощи LLM Mistral более подробные рекоммендации;

---

## Структура проекта

```md
recommendation_service/
├── app/
│   ├── main.py               # Запуск воркера, потребление сообщений из RabbitMQ
│   ├── lyrics_processor.py   # Основная логика обработки сообщений
│   └── models.py             # Типизация структуры сообщений
├── .env                      # Переменные окружения
└── requirements.txt          # Зависимости
```

---

## Описание основных компонентов

### `main.py`

Инициализирует подключение к RabbitMQ, подписывается на входящую очередь `fetch_lyrics` и обрабатывает каждое сообщение с помощью `process_message`.

### `processor.py`

Основная логика:

- проверка наличия текста в CSV;
- запрос к Genius API при необходимости;
- извлечение ключевых слов;
- формирование ответа.

### `repo_csv.py`

Работает с файлом `songs.csv`:

- ищет песню по артисту и названию;
- возвращает текст песни, если он есть.

### `lyrics_api.py`

Ищет песню в Genius, получает ссылку, затем парсит HTML для получения текста.

### `text_compressor.py`

Использует KeyBERT для извлечения топ-5 ключевых слов из текста.

### `rabbit_producer.py`

Формирует и отправляет сообщение-ответ в очередь `lyrics_ready`.

### `models.py`

Содержит описание входного и выходного сообщений (TypedDict):

- `IncomingMessage`
- `OutgoingMessage`

---

## Формат сообщений

### Входящее сообщение (`fetch_lyrics`)

```json
{
  "id": "req1",
  "user_id": "user42",
  "query": "что-то грустное",
  "songs_texts": [
    {
      "artist": "Radiohead",
      "song": "Creep",
      "lyrics": "...",
      "keywords": ["sadness", "alone", ...]
    },
    ...
  ]
}
```

### Выходящее сообщение (`lyrics_ready`)

```json
{
  "id": "req1",
  "user_id": "user42",
  "response": "Рекоммендация 1..."
}
```
