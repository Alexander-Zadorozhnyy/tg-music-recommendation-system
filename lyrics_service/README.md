# Модуль получения текстов песен

## Назначение

Этот модуль предназначен для получения текстов песен по запросам из очереди RabbitMQ. Он:
- проверяет, есть ли песня в локальной базе (CSV);
- при отсутствии — запрашивает текст через API Genius;
- извлекает ключевые слова из текста с помощью KeyBERT;
- возвращает ответ с текстами и ключевыми словами в выходную очередь.

---

## Структура проекта

```
lyrics_service/
├── app/
│   ├── __init__.py
│   ├── main.py               # Запуск воркера, потребление сообщений из RabbitMQ
│   ├── processor.py          # Основная логика обработки сообщений
│   ├── lyrics_api.py         # Работа с Genius API (поиск и загрузка текстов песен)
│   ├── text_compressor.py    # Извлечение ключевых слов из текста (KeyBERT)
│   ├── repo_csv.py           # Получение текста песни из CSV (локальная "БД")
│   ├── rabbit_producer.py    # Отправка результатов обратно в очередь
│   └── models.py             # Типизация структуры сообщений
├── data/
│   └── songs.csv             # CSV-файл с песнями (аналог БД)
├── .env                      # Переменные окружения
├── Dockerfile                # Сборка контейнера
├── docker-compose.yml        # Поднятие контейнеров
├── requirements.txt          # Зависимости
└── send_test_message.py      # Скрипт для отправки тестового сообщения
```

---

## Описание основных компонентов

### `main.py`
Инициализирует подключение к RabbitMQ, подписывается на входящую очередь `fetch_lyrics` и обрабатывает каждое сообщение с помощью `process_message`.

### `processor.py`
Основная логика:
- проверка наличия текста в CSV;
- запрос к Genius API при необходимости;
- извлечение ключевых слов;
- формирование ответа.

### `repo_csv.py`
Работает с файлом `songs.csv`:
- ищет песню по артисту и названию;
- возвращает текст песни, если он есть.

### `lyrics_api.py`
Ищет песню в Genius, получает ссылку, затем парсит HTML для получения текста.

### `text_compressor.py`
Использует KeyBERT для извлечения топ-5 ключевых слов из текста.

### `rabbit_producer.py`
Формирует и отправляет сообщение-ответ в очередь `lyrics_ready`.

### `models.py`
Содержит описание входного и выходного сообщений (TypedDict):
- `IncomingMessage`
- `OutgoingMessage`

---

## Формат сообщений

### Входящее сообщение (`fetch_lyrics`)
```json
{
  "id": "req1",
  "user_id": "user42",
  "song_credits": [
    {"artist": "Radiohead", "track": "Creep"},
    {"artist": "Adele", "track": "Hello"}
  ],
  "query": "что-то грустное"
}
```

### Выходящее сообщение (`lyrics_ready`)
```json
{
  "id": "req1",
  "user_id": "user42",
  "query": "что-то грустное",
  "songs_texts": [
    {
      "artist": "Radiohead",
      "track": "Creep",
      "lyrics": "...",
      "keywords": ["sadness", "alone", ...]
    },
    ...
  ]
}
```

---

## Переменные окружения (`.env` или `docker-compose.yml`)
| Переменная              | Назначение                            |
|------------------------|----------------------------------------|
| `RABBITMQ_HOST`        | Адрес RabbitMQ (в docker: `rabbitmq`) |
| `RABBITMQ_PORT`        | Порт RabbitMQ (по умолчанию `5672`)   |
| `QUEUE_IN`             | Название входной очереди              |
| `QUEUE_OUT`            | Название выходной очереди             |
| `CSV_PATH`             | Путь к `songs.csv`                    |
| `GENIUS_API_TOKEN`     | Токен доступа Genius API              |

---

## Как запустить

1. **Создайте `.env` файл** (или укажите переменные в `docker-compose.yml`).
2. **Запустите сервис:**
```bash
docker-compose up --build
```
3. **Откройте RabbitMQ**: http://localhost:15672 (логин/пароль: `guest` / `guest`).

---

## Как протестировать

1. Используйте `send_test_message.py`:
```bash
python send_test_message.py
```

2. Проверьте очередь `lyrics_ready` — там появится результат.

---

## Примечания

- Если песни нет в `songs.csv`, модуль попытается получить текст через Genius.
- Парсинг текста осуществляется с помощью BeautifulSoup.
- Извлечённые тексты и ключевые слова можно использовать в downstream модулях (например, RAG или фильтрация по темам).
- `songs.csv` — временное решение. В будущем можно заменить на PostgreSQL + OpenSearch.

---

## Возможные улучшения

- Кэшировать тексты песен, полученные с Genius.
- Добавить логирование.
- Вынести обработку ошибок в отдельный модуль.
- Перейти от парсинга HTML к официальной обёртке `lyricsgenius`.
